<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
    <title>Migrate (nearly) any encryption system to AuthLogic</title>
    <link rel="stylesheet" type="text/css" href="/stylesheets/reset.css" />
    <link rel="stylesheet" type="text/css" href="/stylesheets/960gs.css" />
    <link rel="stylesheet" type="text/css" href="/stylesheets/syntax.css" />
    <link rel="stylesheet" type="text/css" href="/stylesheets/default.css" />
    
    <script type="text/javascript" src="/javascripts/jquery-1.3.2.min.js"></script>
    <script type="text/javascript" src="/javascripts/jquery.driveby.js"></script>
    <script type="text/javascript">
      jQuery(document).ready(function() {
        $('#followme').driveBy({
          mouseenter: {
            'opacity': 100
          },
          radius: 250
        }).css('opacity', 0);
        $('#forkme').driveBy({
          mouseenter: {
            'opacity': 100
          }
        }).css('opacity', 0);
      });
    </script>
  </head>
  <body id="body">
    <div id="header" class="centered">
      <div id="myhead"></div>
      <a href="http://github.com/Overbryd" target="_blank" id="forkme">Fork me on Github</a>
      <div id="birdy">
        <a href="#" id="followme">Follow me on Twitter</a>
      </div>
      <div class="inner-shadow"></div>
    </div>
    <div id="background" class="centered clearfix">
      
      <div class="container_12 centered clearfix">
        <div id="content" class="grid_9 clearfix">
          <div class="top bg"></div>
          <div class="middle bg clearfix">
            <div class="inner">
<div class="post">
  <h1>Migrate (nearly) any encryption system to AuthLogic</h1>
  <p>In winter 2008 I wrote the alpha version of <a href="http://paperc.de">PaperC</a>, which uses an outdated version of <code>acts_as_authentic</code>. Spring 2009 all the alpha code was thrown away (it was untested, ugly and impotent) and the decision was made to rewrite PaperC from scratch.<br />
As time goes by and plugins evolve, acts_as_authentic has been replaced by <a href="http://github.com/binarylogic/authlogic">AuthLogic</a>.<br />
The problem I was facing: In Alpha State we&#8217;ve collected over one thousand users, who all wanted to be in Beta too. We couldn&#8217;t drop one of them. How to migrate the hashed passwords?</p>
<h2>AuthLogic for the win!</h2>
<p>AuthLogic was build to replace existing authentication plugins and stay as the dominant plugin for this use case. AuthLogic is so flexible, you can transition from (nearly) any encryption system. By the way AuthLogic can transition from some versions of acts_as_authentic automagically. But I&#8217;ll describe how to transition other combinations of salt/password encryptions.</p>
<h2>A look inside</h2>
<p>AuthLogic is <i>very</i> modular, so we can just write our own CryptoProvider class to handle the old encryption method. To accomplish this mission you&#8217;ll need to understand how AuthLogic passes the password/salt combination into a CryptoProvider class.</p>
<p><i>Note:</i> At the time of writing I was using authlogic 1.4.0</p>
<p>AuthLogic takes the users password, tries if there is a match using the current encryption method. If it doesn&#8217;t match and you&#8217;ve configured it to transition from another encryption method, it will try to match the password using the old encryption method.</p>
<p>To do so it calls <code>matches?</code> on a CryptoProvider class with two arguments: the <code>stored password</code> and an array of encryption arguments (salt and password). The array looks like <code>[raw_password, salt]</code>.</p>
<p>Given, your old encryption stores passwords this way:</p>
<div class="highlight"><pre><span class="k">def</span> <span class="nf">encrypt_password</span><span class="p">(</span><span class="n">password</span><span class="p">)</span>
  <span class="no">Digest</span><span class="o">::</span><span class="no">SHA512</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">(</span><span class="s2">&quot;--</span><span class="si">#{</span><span class="n">salt</span><span class="si">}</span><span class="s2">--</span><span class="si">#{</span><span class="n">password</span><span class="si">}</span><span class="s2">--&quot;</span><span class="p">)</span>
<span class="k">end</span>
</pre>
</div><p>You&#8217;ll need to write a simple class that mimiks the class method <code>matches?</code> of an AuthLogic CryptoProvider.<br />
Mine looks like this:</p>
<div class="highlight"><pre><span class="k">class</span> <span class="nc">OldApplicationSha512</span>
  <span class="c1"># AuthLogic Credentials provides the tokens in the following order:</span>
  <span class="c1">#  [raw_password, salt]</span>
  <span class="c1"># The old application used &#39;--#{salt}--#{password}--&#39;</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">matches?</span><span class="p">(</span><span class="n">crypted</span><span class="p">,</span> <span class="o">*</span><span class="n">tokens</span><span class="p">)</span>
    <span class="no">Digest</span><span class="o">::</span><span class="no">SHA512</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">(</span><span class="s2">&quot;--</span><span class="si">#{</span><span class="n">tokens</span><span class="o">.</span><span class="n">last</span><span class="si">}</span><span class="s2">--</span><span class="si">#{</span><span class="n">tokens</span><span class="o">.</span><span class="n">first</span><span class="si">}</span><span class="s2">--&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">crypted</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre>
</div><p>Here&#8217;s how to wire it up in your user model:</p>
<div class="highlight"><pre><span class="n">acts_as_authentic</span> <span class="ss">:login_field</span> <span class="o">=&gt;</span> <span class="ss">:email</span><span class="p">,</span>
  <span class="ss">:transition_from_crypto_provider</span> <span class="o">=&gt;</span> <span class="no">OldApplicationSha512</span>
</pre>
</div><h3>Job done! But I&#8217;ll leave the writing of tests as an excercise to you&#8230;</h3>
</div>
<div class="date sidebox">
  <span class="title"></span>
  <span class="day"></span>
</div>
<div class="share sidebox">
  <span class="title">Share</span>
</div>
<div class="opinions sidebox">
  <span class="title">Opinions</span>
  <span class="count">0</span>
  <a href="#">add yours</a>
</div></div>
          </div>
          <div class="bottom bg"></div>
        </div>
      
        <div id="sidebar" class="grid_3">
          <div class="inner">
            <div id="aboutme" class="clearfix">
              <div id="coffeemug"></div>
              <p class="small">
                <img src="http://gravatar.com/avatar/171de85d4d79cb7afe725174fb099137.jpg" width="40px" height="40px" alt="My Gravatar" align="left"/>Hy, my name is Lukas Rieder.<br/><br/>
                You can <a href="contact.html">Contact me here</a>.
              </p>
            </div>
            <div id="manifesto">
              <h3>Manifesto</h3>
              <p>I've become a freelancer, because I like to monetize the things I love to do. Freelancing gives me enough responsibility to feel passionate about what I'm doing.
              </p><p>
              Human beeings are not made to follow strict day to day routines. Humans don't fit into robot stuff. Their just too weak, too sloppy or too sleepy to do repetive work.
              For this reason I seek for diversity in what I'm doing.
              </p><p>
              I like people who think forward. I feel comfortable in a sort of positive, future like mindset. Not the predictive stuff. That's odd. Much more the "Hey, I like to make my own way" or "I've never heard of 'Gorilla-Sandboarding-Break-A-Leg' but I'll give it a try".
              </p><p>
              We will probably never get along if you can't find your own motivation not to sleep all day.
              </p><p>
              Work is something that has to be done. Quality and Performance are indicators I'm definitely aware of. But let us talk about the different ways to achieve these goals. I'll listen to your way if you consider mine.
              </p><p>
              Solar panels should be everywhere.</p>
            </div>
          </div>
        </div>
      </div>
          
    </div>
  </body>
</html>